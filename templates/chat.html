<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Medical Chatbot</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://use.fontawesome.com/releases/v5.5.0/css/all.css"
    />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <style>
      #audioPlayer {
        display: none; /* Hide the audio player */
      }
    </style>
  </head>
  <body>
    <div class="container-fluid h-100">
      <div class="row justify-content-center h-100">
        <div class="col-md-8 col-xl-6 chat">
          <div class="card">
            <div class="card-header msg_head">
              <div class="d-flex bd-highlight">
                <div class="img_cont">
                  <img
                    src="https://img.freepik.com/premium-vector/nurse-vector_423075-450.jpg"
                  />
                  <span class="online_icon"></span>
                </div>
                <div class="user_info">
                  <span>Medical Chatbot</span>
                  <p>Ask me anything!</p>
                </div>
              </div>
            </div>
            <div id="messageFormeight" class="card-body msg_card_body"></div>
            <div class="card-footer">
              <form id="messageArea" class="input-group">
                <input
                  type="text"
                  id="text"
                  name="msg"
                  placeholder="Type your message..."
                  autocomplete="off"
                  class="form-control type_msg"
                  required
                />
                <div class="input-group-append">
                  <button
                    type="button"
                    id="voiceInput"
                    class="input-group-text send_btn"
                  >
                    <i class="fas fa-microphone"></i>
                  </button>
                  <button
                    type="submit"
                    id="send"
                    class="input-group-text send_btn"
                  >
                    <i class="fas fa-location-arrow"></i>
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Audio Player -->
    <audio id="audioPlayer" controls style="display: none">
      <source id="audioSource" src="" type="audio/mpeg" />
      Your browser does not support the audio element.
    </audio>

    <script>
      $(document).ready(function () {
        const recognition = new (window.SpeechRecognition ||
          window.webkitSpeechRecognition)();
        recognition.interimResults = false;
        recognition.lang = "en-US";

        $("#voiceInput").click(function () {
          recognition.start();
        });

        recognition.onresult = function (event) {
          const transcript = event.results[0][0].transcript;
          $("#text").val(transcript);
          $("#messageArea").submit();
        };

        recognition.onspeechend = function () {
          recognition.stop();
        };

        $("#messageArea").on("submit", function (event) {
          const date = new Date();
          const hour = date.getHours();
          const minute = date.getMinutes();
          const str_time = hour + ":" + (minute < 10 ? "0" : "") + minute;
          var rawText = $("#text").val();

          var userHtml =
            '<div class="d-flex justify-content-end mb-4"><div class="msg_cotainer_send">' +
            rawText +
            '<span class="msg_time_send">' +
            str_time +
            '</span></div><div class="img_cont_msg"><img src="https://png.pngtree.com/png-clipart/20210312/original/pngtree-wearing-a-mask-of-patients-png-image_6070376.jpg" class="rounded-circle user_img_msg"></div></div>';

          $("#text").val("");
          $("#messageFormeight").append(userHtml);

          $.ajax({
            data: {
              msg: rawText,
            },
            type: "POST",
            url: "/get",
          }).done(function (data) {
            var botHtml =
              '<div class="d-flex justify-content-start mb-4 align-items-center"><div class="img_cont_msg"><img src="https://img.freepik.com/premium-vector/nurse-vector_423075-450.jpg" class="rounded-circle user_img_msg"></div><div class="msg_cotainer">' +
              data.text +
              '<span class="msg_time">' +
              str_time +
              "</span></div><button onclick=\"toggleAudio('" +
              data.audio +
              '\')" class="btn btn-info ml-2"><i class="fas fa-volume-up"></i></button></div>';
            $("#messageFormeight").append($.parseHTML(botHtml));
          });
          event.preventDefault();
        });
      });

      function toggleAudio(audioSrc) {
        const audioPlayer = document.getElementById("audioPlayer");
        const audioSource = document.getElementById("audioSource");

        if (audioPlayer.src.includes(audioSrc)) {
          // If the same audio is clicked, pause and reset
          if (!audioPlayer.paused) {
            audioPlayer.pause();
            audioPlayer.currentTime = 0;
          } else {
            audioPlayer.play();
          }
        } else {
          // If a new audio source, play the new one
          audioSource.src = audioSrc + "?t=" + new Date().getTime(); // Adding a timestamp to avoid caching
          audioPlayer.style.display = "block";
          audioPlayer.load(); // Load the new audio source
          audioPlayer.play(); // Play the audio
        }
      }
    </script>
  </body>
</html>
